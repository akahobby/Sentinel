<Page
    x:Class="Sentinel.App.Pages.ZeroTracePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Fixed top: title, status, search, checkbox, action buttons (no scroll) -->
        <StackPanel Grid.Row="0" Padding="24,24,24,12" Spacing="12">
            <TextBlock x:Name="StepTitleText" Text="{Binding StepTitle}" Style="{StaticResource TitleTextStyle}" />
            <TextBlock x:Name="StatusTextBlock" Text="{Binding StatusText}" Style="{StaticResource CaptionTextStyle}" TextWrapping="Wrap" />
            <TextBox x:Name="SearchBox" Header="Search apps" Text="{Binding SearchText, Mode=TwoWay}" PlaceholderText="Type to filter..." Width="300" HorizontalAlignment="Left" />
            <StackPanel Orientation="Horizontal" Spacing="12">
                <ComboBox Header="Sort by" SelectedItem="{Binding SortBy, Mode=TwoWay}" ItemsSource="{Binding SortOptions}" MinWidth="120" />
            </StackPanel>
            <CheckBox Content="Hide Microsoft apps (recommended)" IsChecked="{Binding HideMicrosoftApps, Mode=TwoWay}" />
            <ProgressRing x:Name="BusyRing" IsActive="{Binding IsBusy}" Width="24" Height="24" />
            <!-- Uninstall appears here when an app is selected (no scrolling) -->
            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button x:Name="UninstallButton" Content="Uninstall" Command="{Binding UninstallCommand}"
                        Visibility="{Binding ShowUninstallInToolbar, Converter={StaticResource BoolToVisibilityConverter}}" />
            </StackPanel>
            <!-- Audit step: Select all, Deselect all, Delete -->
            <StackPanel x:Name="AuditButtonsPanel" Orientation="Horizontal" Spacing="8" Visibility="Collapsed">
                <Button Content="Select all" Command="{Binding SelectAllTargetsCommand}" />
                <Button Content="Deselect all" Command="{Binding DeselectAllTargetsCommand}" />
                <Button x:Name="ProceedButton" Content="Delete" Command="{Binding RunCleanupCommand}" IsEnabled="{Binding IsProceedEnabled}" />
                <Button x:Name="DoneScanOnlyButton" Content="Done" Command="{Binding FinishScanOnlyCommand}" Visibility="Collapsed" />
            </StackPanel>
        </StackPanel>

        <!-- Scrollable list only -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Padding="24,0,24,24">
            <StackPanel Spacing="12">
                <ListView x:Name="AppList" ItemsSource="{Binding Apps}" SelectedItem="{Binding SelectedApp, Mode=TwoWay}" SelectionMode="Single" MinHeight="200">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Padding="8">
                                <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" />
                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,2,0,0">
                                    <TextBlock Text="{Binding Publisher}" Style="{StaticResource CaptionTextStyle}" />
                                    <TextBlock Text="{Binding Source}" Style="{StaticResource CaptionTextStyle}" Foreground="{StaticResource SubtleTextBrush}" />
                                    <TextBlock Text="Â·" Style="{StaticResource CaptionTextStyle}" Foreground="{StaticResource SubtleTextBrush}" />
                                    <TextBlock Text="{Binding SizeBytes, Converter={StaticResource BytesToSizeConverter}}" Style="{StaticResource CaptionTextStyle}" Foreground="{StaticResource SubtleTextBrush}" />
                                </StackPanel>
                            </StackPanel>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
                <ListView x:Name="TargetList" ItemsSource="{Binding TargetItems}" MinHeight="200" SelectionMode="None" Visibility="Collapsed">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <CheckBox Grid.Column="0" IsChecked="{Binding IsIncluded, Mode=TwoWay}" Margin="0,0,8,0" />
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="{Binding KindSourceConfidence}" />
                                    <TextBlock Text="{Binding Value}" TextTrimming="CharacterEllipsis" />
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
