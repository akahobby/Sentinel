<Page
    x:Class="Sentinel.App.Pages.ProcessesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:viewmodels="using:Sentinel.App.ViewModels"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Padding="24,20" Spacing="8">
            <TextBlock Text="Processes" Style="{StaticResource TitleTextStyle}" />
            <TextBlock Text="Running processes. Groups with multiple instances are expandable. Sort by CPU, memory, GPU, or network." Style="{StaticResource CaptionTextStyle}" TextWrapping="Wrap" />
            <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,10,0,0">
                <TextBox x:Name="SearchBox" PlaceholderText="Search by name..." Width="260" Text="{Binding SearchText, Mode=TwoWay}" />
                <ComboBox Header="Sort by" SelectedItem="{Binding SortBy, Mode=TwoWay}" ItemsSource="{Binding SortOptions}" MinWidth="140" />
            </StackPanel>
        </StackPanel>

        <Grid Grid.Row="1" Padding="24,0,24,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="320" />
                <ColumnDefinition Width="12" />
                <ColumnDefinition Width="340" />
            </Grid.ColumnDefinitions>

            <!-- Process list: groups (expandable) and single/child rows -->
            <ListView Grid.Column="0"
                      x:Name="ProcessList"
                      ItemsSource="{Binding FilteredRows, Mode=OneWay}"
                      SelectionMode="Single"
                      SelectionChanged="ProcessList_SelectionChanged"
                      Margin="0,0,8,0"
                      Background="Transparent">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Background" Value="Transparent" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.Header>
                    <Grid Padding="8,6" BorderBrush="{StaticResource CardBorderBrush}" BorderThickness="0,0,0,1" Margin="0,0,0,4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="28" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="56" />
                            <ColumnDefinition Width="64" />
                            <ColumnDefinition Width="48" />
                            <ColumnDefinition Width="64" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="1" Text="Name" Style="{StaticResource CaptionTextStyle}" FontWeight="SemiBold" />
                        <TextBlock Grid.Column="2" Text="CPU %" Style="{StaticResource CaptionTextStyle}" FontWeight="SemiBold" />
                        <TextBlock Grid.Column="3" Text="Mem MB" Style="{StaticResource CaptionTextStyle}" FontWeight="SemiBold" />
                        <TextBlock Grid.Column="4" Text="GPU %" Style="{StaticResource CaptionTextStyle}" FontWeight="SemiBold" />
                        <TextBlock Grid.Column="5" Text="Net Kbps" Style="{StaticResource CaptionTextStyle}" FontWeight="SemiBold" />
                    </Grid>
                </ListView.Header>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:ProcessRowViewModel">
                        <StackPanel>
                            <!-- Section header: foldable Currently in use / Background / Windows -->
                            <Button Visibility="{x:Bind SectionHeaderVisibility, Mode=OneWay}" Click="SectionHeader_Click"
                                    Background="{StaticResource CardBackgroundBrush}" Padding="14,12" Margin="0,6,0,4" CornerRadius="8" BorderBrush="{StaticResource CardBorderBrush}" BorderThickness="1" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <FontIcon Glyph="{x:Bind SectionIcon, Mode=OneWay}" FontSize="14" VerticalAlignment="Center" Opacity="0.9" />
                                    <TextBlock Text="{x:Bind SectionTitle}" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
                                    <FontIcon Glyph="{x:Bind SectionChevron, Mode=OneWay}" FontSize="12" VerticalAlignment="Center" Opacity="0.8" Margin="4,0,0,0" />
                                </StackPanel>
                            </Button>
                            <!-- Normal row: process or group (card style) -->
                            <Border Visibility="{x:Bind ContentVisibility, Mode=OneWay}" Background="{StaticResource CardBackgroundBrush}" BorderBrush="{StaticResource CardBorderBrush}" BorderThickness="1" CornerRadius="6" Margin="0,2,0,2" Padding="0">
                                <Grid Padding="4,4,12,4">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Button Grid.Column="0" Width="28" Height="28" Padding="0" Margin="4,2,0,2" VerticalAlignment="Center"
                                        Visibility="{x:Bind GroupHeaderButtonVisibility, Mode=OneWay}"
                                        Click="ExpandButton_Click">
                                    <Button.Content>
                                        <FontIcon Glyph="{x:Bind ExpandChevron, Mode=OneWay}" FontSize="10" />
                                    </Button.Content>
                                </Button>
                                <Border Grid.Column="0" Width="28" Height="28" Margin="4,2,0,2" VerticalAlignment="Center" Visibility="{x:Bind SingleRowSpacerVisibility, Mode=OneWay}" />
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6" Padding="8,8,8,8" VerticalAlignment="Center">
                                    <TextBlock Text="{x:Bind DisplayName}" FontWeight="SemiBold" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" MaxWidth="180" />
                                    <TextBlock Text="{x:Bind Subtitle}" Style="{StaticResource CaptionTextStyle}" VerticalAlignment="Center" Opacity="0.85" />
                                </StackPanel>
                                <TextBlock Grid.Column="2" Text="{x:Bind FormattedCpu, Mode=OneWay}" Style="{StaticResource CaptionTextStyle}" VerticalAlignment="Center" Margin="0,0,12,0" />
                                <TextBlock Grid.Column="3" Text="{x:Bind FormattedMemory, Mode=OneWay}" Style="{StaticResource CaptionTextStyle}" VerticalAlignment="Center" Margin="0,0,12,0" />
                                <TextBlock Grid.Column="4" Text="{x:Bind FormattedGpu, Mode=OneWay}" Style="{StaticResource CaptionTextStyle}" VerticalAlignment="Center" Margin="0,0,12,0" />
                                <TextBlock Grid.Column="5" Text="{x:Bind FormattedNetwork, Mode=OneWay}" Style="{StaticResource CaptionTextStyle}" VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                        </StackPanel>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <!-- Details pane -->
            <Border Grid.Column="2" x:Name="DetailsPane" Background="{StaticResource CardBackgroundBrush}" CornerRadius="{StaticResource CornerRadiusCard}" Padding="20" BorderBrush="{StaticResource CardBorderBrush}" BorderThickness="1" Visibility="Collapsed">
                <ScrollViewer>
                    <StackPanel Spacing="14">
                        <TextBlock x:Name="DetailsName" Style="{StaticResource SectionTextStyle}" Text="Select a process" />
                        <TextBlock x:Name="DetailsPid" Style="{StaticResource CaptionTextStyle}" />
                        <TextBlock x:Name="DetailsPath" Style="{StaticResource CaptionTextStyle}" TextWrapping="Wrap" />
                        <Rectangle Height="1" Fill="{StaticResource CardBorderBrush}" Margin="0,4,0,4" />
                        <TextBlock Text="Usage" Style="{StaticResource BodyTextStyle}" FontWeight="SemiBold" />
                        <TextBlock x:Name="DetailsCpuMem" Style="{StaticResource BodyTextStyle}" />
                        <TextBlock x:Name="DetailsGpuNet" Style="{StaticResource CaptionTextStyle}" />
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
    </Grid>
</Page>
